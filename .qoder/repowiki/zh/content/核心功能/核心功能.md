# 核心功能

<cite>
**Referenced Files in This Document**   
- [component_palette.py](file://src/components/component_palette.py)
- [properties_panel.py](file://src/components/properties_panel.py)
- [simulation_window.py](file://src/components/simulation_window.py)
- [modbus_manager.py](file://src/components/modbus_manager.py)
- [data_control.py](file://src/components/data_control.py)
- [network_model.py](file://src/models/network_model.py)
</cite>

## 目录
1. [组件面板](#组件面板)
2. [属性面板](#属性面板)
3. [仿真窗口](#仿真窗口)
4. [Modbus管理器](#modbus管理器)
5. [数据控制](#数据控制)

## 组件面板
组件面板（`component_palette.py`）是pp_tool的核心交互界面之一，它提供了一个可拖拽的电网元件库，允许用户通过直观的图形化操作来构建电网拓扑。该面板继承自`QListWidget`，并利用Qt的拖拽机制实现元件的添加。

当用户从面板中拖拽一个元件（如“母线”、“线路”或“外部电网”）到画布上时，会触发`startDrag`方法。此方法创建一个`QDrag`对象，并将元件的类型（如`bus`、`line`、`external_grid`）作为MIME数据（`QMimeData`）进行封装。这个过程使得画布能够识别被拖拽的元件类型，并在释放时创建相应的图形项。

面板的UI初始化（`init_ui`）设置了拖拽模式，并通过`add_components`方法将所有支持的电网元件添加到列表中。每个元件都配有SVG图标，且`create_themed_icon`方法会根据当前应用的主题（深色或浅色）动态调整图标的颜色，确保在不同主题下都有良好的视觉效果。

**Section sources**
- [component_palette.py](file://src/components/component_palette.py#L1-L168)

## 属性面板
属性面板（`properties_panel.py`）负责动态显示和编辑在画布上选中的电网元件的属性。当用户选择一个元件时，主窗口的`canvas`会发出`selection_changed`信号，该信号连接到属性面板的`update_properties`方法，从而触发属性的更新。

`update_properties`方法是核心逻辑。它首先清空当前显示的属性，然后根据选中元件的`component_type`（如`load`、`static_generator`），调用`get_component_properties`方法获取该类型元件的所有可配置属性。这些属性定义了元件的参数，例如负载（`load`）的有功功率（`p_mw`）、光伏（`static_generator`）的额定容量（`sn_mva`）等。

对于每个属性，面板会根据其`type`（如`float`、`int`、`bool`、`choice`）创建相应的编辑控件（如`QDoubleSpinBox`、`QSpinBox`、`QCheckBox`、`QComboBox`）。特别地，对于`line`和`transformer`等元件，其属性会根据`use_standard_type`的布尔值动态显示或隐藏。当用户修改属性值时，`on_property_changed`方法会被调用，它不仅更新元件的`properties`字典，还会发出`property_changed`信号，通知其他模块（如网络模型）进行相应的更新。

**Section sources**
- [properties_panel.py](file://src/components/properties_panel.py#L1-L800)

## 仿真窗口
仿真窗口（`simulation_window.py`）是pp_tool的核心功能集成中心，它集成了pandapower进行潮流计算，并通过多个停靠窗口展示仿真结果。

当用户点击“仿真模式”时，会创建`SimulationWindow`实例。该窗口在初始化时，会创建一个`NetworkModel`实例，并调用`create_from_network_items`方法，将画布上的所有元件转换为pandapower的网络模型（`self.net`）。这个过程是通过遍历`network_items`字典，根据元件类型和连接关系，调用pandapower的`create_bus`、`create_line`、`create_load`等函数来完成的。

潮流计算由`auto_power_flow_calculation`方法驱动，该方法通过一个`QTimer`定时器周期性地调用`runpp`函数。计算完成后，结果（如`res_bus`、`res_line`）会被存储在`self.net`中。`PowerMonitor`类负责从这些结果中提取实时数据（如母线电压、线路功率），并更新到UI上。例如，`update_sgen_context`方法会读取`net.res_sgen`中光伏元件的有功功率，并将其写入Modbus寄存器，从而实现仿真结果的实时反馈。

**Section sources**
- [simulation_window.py](file://src/components/simulation_window.py#L1-L800)
- [network_model.py](file://src/models/network_model.py#L1-L710)

## Modbus管理器
Modbus管理器（`modbus_manager.py`）为每个支持通信的设备（如储能、充电桩、光伏）启动一个独立的Modbus TCP服务器，以实现与外部系统的通信模拟。

`ModbusManager`类通过`scan_ip_devices`方法扫描所有具有IP和端口配置的元件，并为每个设备创建一个`ModbusServerContext`。`create_modbus_context`方法根据设备类型（`device_type`）调用不同的子方法（如`_create_storage_context`、`_create_charger_context`）来构建定制化的寄存器映射。例如，储能设备的上下文会预设一系列保持寄存器（`hr`）和输入寄存器（`ir`），用于模拟其功率、SOC等状态。

`start_modbus_server`方法是启动服务器的关键。它在一个独立的线程中创建并运行`ModbusTcpServer`的异步事件循环，避免阻塞主UI线程。当服务器运行时，`update_storage_context`等方法会周期性地从`PowerMonitor`获取最新的功率数据，并通过`slave_context.setValues()`更新到对应的Modbus寄存器中，从而实现了仿真数据与Modbus协议的实时同步。

**Section sources**
- [modbus_manager.py](file://src/components/modbus_manager.py#L1-L800)

## 数据控制
数据控制模块（`data_control.py`）通过`DataControlManager`类，为仿真提供了数据记录和回测功能。

该模块通过`record_simulation_data`和`stop_record_data`方法控制数据记录。当开始记录时，会启动一个后台线程`_record_data_loop`，该线程定期从`PowerMonitor`获取所有设备的测量值（如功率、电压），并将这些数据连同时间戳一起写入SQLite数据库。

回测功能通过`import_backtest_data`和`start_backtest`方法实现。用户可以导入一个包含历史数据的SQLite数据库。在回测模式下，系统会按时间步长读取数据库中的数据，并调用`run_backtest_step`方法。该方法会将读取到的功率值（如`p_mw`）直接写入`network_model.net`中对应元件的参数，从而“重放”历史场景，实现对历史数据的模拟和验证。

**Section sources**
- [data_control.py](file://src/components/data_control.py#L1-L1599)