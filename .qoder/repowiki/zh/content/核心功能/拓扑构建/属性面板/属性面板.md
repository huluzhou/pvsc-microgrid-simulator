# 属性面板

<cite>
**本文档引用的文件**   
- [properties_panel.py](file://src/components/properties_panel.py)
- [network_items.py](file://src/components/network_items.py)
- [main_window.py](file://src/components/main_window.py)
- [canvas.py](file://src/components/canvas.py)
- [modbus_manager.py](file://src/components/modbus_manager.py)
</cite>

## 目录
1. [引言](#引言)
2. [属性面板架构](#属性面板架构)
3. [核心组件分析](#核心组件分析)
4. [属性定义机制](#属性定义机制)
5. [UI控件创建](#ui控件创建)
6. [属性变更处理](#属性变更处理)
7. [条件显示逻辑](#条件显示逻辑)
8. [新元件类型定义示例](#新元件类型定义示例)
9. [结论](#结论)

## 引言
属性面板是pp_tool应用中的核心功能模块，负责为用户选中的电网元件动态生成和显示其属性表单。该模块通过`PropertiesPanel`类实现，能够根据不同的电网元件类型（如线路、变压器、负载、储能等）展示相应的属性配置界面。本文档将深入分析该模块的实现机制，重点阐述其如何定义元件属性结构、创建UI控件以及处理属性变更事件。

## 属性面板架构
属性面板模块采用面向对象的设计模式，以`PropertiesPanel`类为核心，继承自`QWidget`。该类通过信号-槽机制与主窗口和其他组件进行通信，实现了属性值改变时的实时响应。

```mermaid
classDiagram
class PropertiesPanel {
+property_changed : Signal
+current_item : object
+property_widgets : dict
+init_ui() void
+show_no_selection() void
+clear_properties() void
+update_properties(item) void
+get_connected_bus_name(item) str
+create_property_widget(prop_name, prop_info, current_value) QWidget
+on_property_changed(prop_name, new_value) void
+_update_modbus_registers(prop_name, new_value) void
+get_component_properties(component_type) dict
+is_dark_theme() bool
}
PropertiesPanel --> QWidget : "继承"
PropertiesPanel --> Signal : "使用"
```

**Diagram sources**
- [properties_panel.py](file://src/components/properties_panel.py#L12-L800)

**Section sources**
- [properties_panel.py](file://src/components/properties_panel.py#L12-L800)

## 核心组件分析
属性面板的核心功能由`PropertiesPanel`类实现，该类通过`update_properties`方法根据用户选中的元件动态更新属性显示。当用户选择一个元件时，系统会调用此方法，清除当前显示的属性，并根据元件类型重新生成相应的属性表单。

```mermaid
sequenceDiagram
participant 用户
participant 属性面板
participant 主窗口
participant 画布
用户->>画布 : 选择电网元件
画布->>主窗口 : 发出selection_changed信号
主窗口->>属性面板 : 调用update_properties方法
属性面板->>属性面板 : 清除现有属性显示
属性面板->>属性面板 : 获取元件属性定义
属性面板->>属性面板 : 创建UI控件
属性面板->>属性面板 : 显示属性表单
```

**Diagram sources**
- [properties_panel.py](file://src/components/properties_panel.py#L88-L231)
- [main_window.py](file://src/components/main_window.py#L175-L178)
- [canvas.py](file://src/components/canvas.py#L60-L61)

**Section sources**
- [properties_panel.py](file://src/components/properties_panel.py#L88-L231)
- [main_window.py](file://src/components/main_window.py#L175-L178)
- [canvas.py](file://src/components/canvas.py#L60-L61)

## 属性定义机制
`get_component_properties`方法是属性面板的核心，它定义了不同电网元件的属性结构。该方法返回一个字典，其中包含各种元件类型（如线路、变压器、负载、储能等）的属性定义。

```mermaid
erDiagram
COMPONENT_TYPE ||--o{ PROPERTY : "has"
PROPERTY ||--o{ ATTRIBUTE : "has"
COMPONENT_TYPE {
string type PK
}
PROPERTY {
string name PK
string type
string label
any default
float min
float max
int decimals
list choices
string condition
}
ATTRIBUTE {
string key PK
string value
}
```

**Diagram sources**
- [properties_panel.py](file://src/components/properties_panel.py#L511-L790)

**Section sources**
- [properties_panel.py](file://src/components/properties_panel.py#L511-L790)

## UI控件创建
`create_property_widget`方法根据属性定义创建对应的UI控件。该方法根据属性类型（如float、int、bool、choice等）创建相应的控件，如`QDoubleSpinBox`、`QSpinBox`、`QCheckBox`、`QComboBox`等。

```mermaid
flowchart TD
Start([开始]) --> CheckType["检查属性类型"]
CheckType --> |float| CreateDoubleSpinBox["创建QDoubleSpinBox"]
CheckType --> |int| CreateSpinBox["创建QSpinBox"]
CheckType --> |bool| CreateCheckBox["创建QCheckBox"]
CheckType --> |choice| CreateComboBox["创建QComboBox"]
CheckType --> |note| CreateLabel["创建QLabel"]
CheckType --> |readonly| CreateLineEdit["创建只读QLineEdit"]
CheckType --> |default| CreateLineEdit["创建QLineEdit"]
CreateDoubleSpinBox --> SetRange["设置范围和小数位数"]
CreateSpinBox --> SetRange
CreateCheckBox --> ConnectSignal["连接信号"]
CreateComboBox --> SetChoices["设置选项"]
CreateLabel --> SetStyle["设置样式"]
CreateLineEdit --> SetReadOnly["设置只读"]
SetRange --> ConnectSignal
SetChoices --> ConnectSignal
SetStyle --> ConnectSignal
SetReadOnly --> ConnectSignal
ConnectSignal --> ReturnWidget["返回控件"]
ReturnWidget --> End([结束])
```

**Diagram sources**
- [properties_panel.py](file://src/components/properties_panel.py#L250-L335)

**Section sources**
- [properties_panel.py](file://src/components/properties_panel.py#L250-L335)

## 属性变更处理
`on_property_changed`方法是属性面板的关键，它不仅更新元件属性，还实现了IP和端口的唯一性验证、Modbus寄存器的同步更新以及`use_standard_type`等条件属性改变时的界面刷新机制。

```mermaid
sequenceDiagram
participant 属性控件
participant 属性面板
participant 画布
participant ModbusManager
属性控件->>属性面板 : 值改变事件
属性面板->>属性面板 : 验证IP和端口唯一性
alt IP和端口冲突
属性面板->>用户 : 显示警告对话框
属性面板->>属性控件 : 恢复原值
属性面板-->>属性控件 : 返回
else 无冲突
属性面板->>属性面板 : 更新元件属性
属性面板->>属性面板 : 处理特殊属性
alt 名称改变
属性面板->>元件 : 更新component_name
属性面板->>标签 : 更新显示
属性面板->>属性控件 : 同步sn
else 额定功率改变
属性面板->>元件 : 调用update_power_limits
属性面板->>属性面板 : 调用_update_modbus_registers
else use_standard_type改变
属性面板->>属性面板 : 调用update_properties刷新界面
end
属性面板->>主窗口 : 发出property_changed信号
end
```

**Diagram sources**
- [properties_panel.py](file://src/components/properties_panel.py#L336-L445)
- [modbus_manager.py](file://src/components/modbus_manager.py#L446-L505)

**Section sources**
- [properties_panel.py](file://src/components/properties_panel.py#L336-L445)
- [modbus_manager.py](file://src/components/modbus_manager.py#L446-L505)

## 条件显示逻辑
属性面板实现了复杂的条件显示逻辑，根据元件的特定属性值动态控制其他属性的显示。例如，当线路或变压器使用标准类型时，会隐藏自定义参数；当光伏或负载使用功率因数模式时，会显示相应的功率因数参数。

```mermaid
flowchart TD
Start([开始]) --> CheckComponentType["检查元件类型"]
CheckComponentType --> |线路| CheckUseStandardType["检查use_standard_type"]
CheckUseStandardType --> |True| HideCustomParams["隐藏自定义参数"]
CheckUseStandardType --> |False| ShowCustomParams["显示自定义参数"]
CheckComponentType --> |变压器| CheckUseStandardType
CheckUseStandardType --> |True| ShowStandardType["显示标准类型"]
CheckUseStandardType --> |False| ShowCustomParams
CheckComponentType --> |光伏| CheckUsePowerFactor["检查use_power_factor"]
CheckUsePowerFactor --> |True| ShowPowerFactorParams["显示功率因数参数"]
CheckUsePowerFactor --> |False| ShowDirectPowerParams["显示直接功率参数"]
CheckComponentType --> |负载| CheckUsePowerFactor
CheckUsePowerFactor --> |True| ShowPowerFactorParams
CheckUsePowerFactor --> |False| ShowDirectPowerParams
CheckComponentType --> |充电桩| CheckUsePowerFactor
CheckUsePowerFactor --> |True| ShowPowerFactorParams
CheckUsePowerFactor --> |False| ShowDirectPowerParams
HideCustomParams --> End([结束])
ShowCustomParams --> End
ShowStandardType --> End
ShowPowerFactorParams --> End
ShowDirectPowerParams --> End
```

**Diagram sources**
- [properties_panel.py](file://src/components/properties_panel.py#L123-L222)

**Section sources**
- [properties_panel.py](file://src/components/properties_panel.py#L123-L222)

## 新元件类型定义示例
为新元件类型定义属性集的代码示例如下：

```python
def get_component_properties(self, component_type):
    """获取组件属性定义"""
    properties = {
        # ... 其他元件类型定义 ...
        
        'new_component': {
            'index': {'type': 'readonly', 'label': '组件索引'},
            'geodata': {'type': 'readonly', 'label': '位置'},
            'param1': {'type': 'float', 'label': '参数1', 'default': 1.0, 'min': 0.0, 'max': 100.0},
            'param2': {'type': 'int', 'label': '参数2', 'default': 10, 'min': 1, 'max': 100},
            'param3': {'type': 'bool', 'label': '参数3', 'default': True},
            'param4': {
                'type': 'choice', 
                'label': '参数4', 
                'choices': ['选项1', '选项2', '选项3'], 
                'default': '选项1'
            },
            'param5': {'type': 'str', 'label': '参数5', 'default': ''},
            'note': {'type': 'note', 'content': '这是说明信息'}
        },
    }
    
    return properties.get(component_type, {})
```

**Section sources**
- [properties_panel.py](file://src/components/properties_panel.py#L511-L790)

## 结论
属性面板模块通过`get_component_properties`方法定义了各种电网元件的属性结构，包括数据类型、默认值、取值范围以及条件显示逻辑。`create_property_widget`方法根据这些定义创建相应的UI控件，而`on_property_changed`方法则处理属性变更，实现了IP和端口的唯一性验证、Modbus寄存器的同步更新以及条件属性改变时的界面刷新机制。这种设计使得属性面板能够灵活地适应不同类型的电网元件，为用户提供直观、易用的属性配置界面。