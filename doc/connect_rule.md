# 拓扑连接规则（基于 pandapower 数据模型）

## 术语
- 连接点：设备用于形成连接的端口。母线与功率设备各 1 个连接点；线路、变压器、开关各 2 个连接点。
- 节点设备：母线。
- 连接设备：线路、变压器、开关。
- 功率设备：负荷、储能、静态发电、充电等。
- 电表：可附着在母线或设备端口的测量设备。

## 全局约束
- 已存在的连接不允许重复创建。
- 母线的连接点允许承载多个不同连接。
- 目前外部电网设备全局仅允许 1 个。
- 不允许母线与母线直接连接。
- 不允许同一设备的两个连接点同时连接到对端同一个连接点（端口）。

## 母线（节点设备）
- 拥有且仅有 1 个连接点。
- 允许被线路、变压器、开关、功率设备以及电表连接。

## 功率设备
- 每个功率设备拥有且仅有 1 个连接点。
- 仅允许与 1 个母线连接；若未连接则允许创建，已连接则不允许重复。
- 可选连接 1 个电表；每设备最多 1 个。
- 外部电网属于功率设备范畴，但设备总数最多 1 个。

## 线路（连接设备）
- 拥有 2 个连接点：起点与终点。
- 每个连接点仅可与 1 个母线或 1 个开关连接；同时最多允许附着 1 个电表。
- 与母线连接：未连接时允许创建；创建后更新 `from_bus/to_bus`（分别对应起点/终点）。
- 与开关连接：该端未连接且另一端未连接开关时允许；创建后更新开关的连接元件类型为线路，并记录线路索引；禁止线路两端同时连接开关。
- 与电表连接：每个连接点至多 1 个电表。

## 变压器（连接设备）
- 拥有 2 个连接点：高压侧与低压侧。
- 每个连接点仅可与 1 个母线或 1 个开关连接；同时最多允许附着 1 个电表。
- 与母线连接：未连接时允许创建；创建后更新 `hv_bus/lv_bus`（分别对应高压侧/低压侧）。
- 与开关连接：该端未连接且另一端未连接开关时允许；创建后更新开关的连接元件类型为变压器，并记录变压器索引；禁止变压器两端同时连接开关。
- 与电表连接：每个连接点至多 1 个电表。

## 开关（连接设备）
- 拥有 2 个连接点；每端允许连接的对象类型为母线、线路、变压器。
- **不允许连接电表**。
- 稳态约束：至少一端必须连接母线。搭建过程中可先连线路/变压器，但形成闭合连接后必须满足母线端约束。
- 两端均未连接时：
  - 与母线连接：记录开关该端的母线索引。
  - 与线路/变压器连接：记录开关的连接元件类型与索引。
- 一端已连接母线时：
  - 与母线连接：允许，记录另一端母线索引。
  - 与线路起点连接：更新线路 `from_bus` 为开关另一端的母线索引；并记录开关元件类型为线路及线路索引。
  - 与线路终点连接：更新线路 `to_bus` 为开关另一端的母线索引；并记录开关元件类型为线路及线路索引。
  - 与变压器高压侧连接：更新变压器 `hv_bus` 为开关另一端的母线索引；并记录开关元件类型为变压器及变压器索引。
  - 与变压器低压侧连接：更新变压器 `lv_bus` 为开关另一端的母线索引；并记录开关元件类型为变压器及变压器索引。
- 一端已连接线路起点/终点时：
  - 另一端仅允许连接母线；与母线形成闭合后，更新线路相应的 `from_bus/to_bus` 为开关另一端的母线索引。
- 一端已连接变压器高压侧/低压侧时：
  - 另一端仅允许连接母线；与母线形成闭合后，更新变压器相应的 `hv_bus/lv_bus` 为开关另一端的母线索引。

## 电表
- 可连接至母线、线路端口、变压器端口或功率设备连接点。
- **不允许连接开关**。
- 每个目标端口仅允许 1 个电表连接。
- 每个电表自身仅允许 1 条连接。

## 规则速查（设备 × 允许连接对象）
- 母线：可与线路、变压器、开关、功率设备、电表连接
- 功率设备：仅与 1 个母线连接；可附 1 个电表；不与开关/线路/变压器直接连接
- 线路端口：母线或开关（二选一）；端口至多 1 个电表；禁止两端同时接开关
- 变压器端口：母线或开关（二选一）；端口至多 1 个电表；禁止两端同时接开关
- 开关端口：母线、线路、变压器；稳态至少一端接母线；不允许连接电表
- 电表：可附着母线、线路端口、变压器端口、功率设备连接点；每目标端口至多 1 个；每功率设备至多 1 个；不允许连接开关

## 连接动作的联动更新
- 线路 ↔ 母线：根据连接端更新 `from_bus` 或 `to_bus`
- 开关 ↔ 线路：记录开关连接元件类型为线路，并记录线路索引
- 变压器 ↔ 母线：根据连接端更新 `hv_bus` 或 `lv_bus`
- 开关 ↔ 变压器：记录开关连接元件类型为变压器，并记录变压器索引
- 开关两端形成“母线—线路/变压器”闭合：同步更新对应设备的 `from_bus/to_bus` 或 `hv_bus/lv_bus` 为另一端母线索引

## 能否连接的决策流程
- 检查是否已存在同一连接：已存在则拒绝
- 判断设备类型组合是否允许：按“规则速查”确定
- 判断端口占用是否满足：需满足“单端只允许 1 连接”的约束
- 针对开关的稳态约束：最终至少一端为母线
- 针对电表的数量约束：每目标端口 ≤ 1；每功率设备 ≤ 1
- 外部电网唯一性：新建或变更时确保系统中仅 1 个外部电网设备

## 典型搭建示例
- 线路经开关闭合到两母线：
  - 端 A：开关 ↔ 母线；端 B：开关 ↔ 线路起点；随后开关另一端 ↔ 母线
  - 联动：更新线路 `from_bus/to_bus` 为另一端母线索引；开关记录元素类型与索引
- 变压器经开关闭合到两母线：
  - 端 A：开关 ↔ 母线；端 B：开关 ↔ 变压器高/低压侧；随后开关另一端 ↔ 母线
  - 联动：更新变压器 `hv_bus/lv_bus` 为另一端母线索引；开关记录元素类型与索引
- 功率设备接入母线并加电表：
  - 功率设备 ↔ 母线；功率设备连接点 ↔ 电表
  - 约束：功率设备仅 1 母线；电表在该设备上至多 1 个
