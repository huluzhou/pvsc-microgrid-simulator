# 设备扫描与发现

<cite>
**本文档引用的文件**   
- [modbus_manager.py](file://src/components/modbus_manager.py)
- [network_items.py](file://src/components/network_items.py)
- [data_control.py](file://src/components/data_control.py)
</cite>

## 目录
1. [方法概述](#方法概述)
2. [实现机制详解](#实现机制详解)
3. [IP配置处理](#ip配置处理)
4. [功率参数映射](#功率参数映射)
5. [调用示例](#调用示例)
6. [触发时机](#触发时机)

## 方法概述

`scan_ip_devices`方法是ModbusManager类中的核心功能之一，负责扫描系统中所有具有IP属性的网络设备。该方法通过遍历`network_items`中的所有网络组件，检查其`properties`属性中是否包含'ip'字段，并据此构建包含设备类型、索引、名称、SN、IP地址、端口及其他配置参数的设备信息列表。此方法在系统初始化和网络拓扑变更时被调用，为后续启动Modbus服务提供设备清单。

**Section sources**
- [modbus_manager.py](file://src/components/modbus_manager.py#L84-L119)

## 实现机制详解

`scan_ip_devices`方法通过双重循环遍历`self.network_items`字典中的所有网络项。外层循环遍历不同类型的组件（如`static_generator`、`storage`等），内层循环遍历每种类型下的具体设备实例。对于每个设备项，方法首先检查其是否具有`properties`属性且该属性中包含'ip'字段。

当满足条件时，方法会创建一个包含设备详细信息的字典，包括：
- **type**: 设备类型，取自`item.component_type`
- **index**: 设备索引，取自`item.component_index`
- **name**: 设备名称，优先使用`properties`中的'name'字段，否则使用默认命名规则
- **sn**: 设备序列号，取自`properties`中的'sn'字段
- **ip**: IP地址，使用配置的IP地址或默认值'0.0.0.0'
- **port**: 端口号，取自`properties`中的'port'字段，默认为502
- **p_mw**: 有功功率，取自`properties`中的'p_mw'字段
- **q_mvar**: 无功功率，取自`properties`中的'q_mvar'字段
- **sn_mva**: 额定容量，取自`properties`中的'sn_mva'字段
- **max_e_mwh**: 最大储能容量，取自`properties`中的'max_e_mwh'字段

构建的设备信息会被添加到`self.ip_devices`列表中，最终返回该列表供后续使用。

**Section sources**
- [modbus_manager.py](file://src/components/modbus_manager.py#L84-L119)

## IP配置处理

`scan_ip_devices`方法对IP配置的处理体现了良好的容错性。当设备的IP配置为空或缺失时，方法不会直接报错或跳过该设备，而是使用默认IP地址'0.0.0.0'。这种处理方式确保了即使某些设备未正确配置IP地址，系统仍能继续运行，避免了因单个设备配置问题导致整个系统无法启动的情况。

具体实现中，方法通过以下逻辑确定有效IP地址：
```python
ip = item.properties["ip"]
effective_ip = ip if ip else "0.0.0.0"
```
这种设计既尊重了用户的配置意图，又保证了系统的健壮性。在实际应用中，'0.0.0.0'通常表示设备尚未配置具体IP地址，系统可以在此基础上进行进一步的配置或提示用户完善设置。

**Section sources**
- [modbus_manager.py](file://src/components/modbus_manager.py#L97-L98)

## 功率参数映射

`scan_ip_devices`方法在构建设备信息时，会将pandapower网络模型中的功率参数（如`p_mw`、`q_mvar`）直接映射到Modbus设备上下文中。这些参数从设备的`properties`字典中获取，作为设备配置的一部分。

在后续的Modbus上下文创建过程中，这些功率参数会被写入相应的寄存器中，供外部系统读取。例如，在光伏设备的上下文中，`p_mw`参数会被用于计算额定功率并写入寄存器5000；在储能设备的上下文中，`sn_mva`参数会被转换为kW单位并写入相应的寄存器。

这种直接映射的方式简化了数据传递流程，确保了Modbus设备上下文中的数据与pandapower网络模型保持一致，为系统的实时监控和控制提供了可靠的数据基础。

**Section sources**
- [modbus_manager.py](file://src/components/modbus_manager.py#L111-L112)

## 调用示例

以下代码展示了如何调用`scan_ip_devices`方法获取待启动Modbus服务的设备清单：

```python
# 获取ModbusManager实例
modbus_manager = self.parent_window.modbus_manager

# 扫描具有IP属性的设备
ip_devices = modbus_manager.scan_ip_devices()

# 输出发现的设备数量
print(f"发现 {len(ip_devices)} 个具有IP属性的设备")

# 遍历设备清单并启动Modbus服务器
for device_info in ip_devices:
    modbus_manager.start_modbus_server(device_info)
```

在实际应用中，通常会结合`start_all_modbus_servers`方法来批量启动所有设备的Modbus服务。该方法内部会先调用`scan_ip_devices`获取设备清单，然后逐一启动每个设备的Modbus服务器。

**Section sources**
- [modbus_manager.py](file://src/components/modbus_manager.py#L977-L982)

## 触发时机

`scan_ip_devices`方法主要在以下两个时机被触发：

1. **系统初始化时**：在`start_all_modbus_servers`方法中被调用，用于在系统启动时扫描所有具有IP属性的设备并启动相应的Modbus服务。这是该方法最主要的触发时机，确保系统启动后所有配置了IP的设备都能立即提供Modbus服务。

2. **网络拓扑变更时**：当用户修改网络拓扑结构（如添加、删除或修改设备）后，系统需要重新扫描设备列表以反映最新的网络状态。虽然当前代码中未直接显示这一触发逻辑，但通过`data_control.py`中的设备控制逻辑可以看出，系统具备动态管理设备通信状态的能力。

此外，该方法还可能在系统资源清理后被调用，以重新建立Modbus服务。例如，在调用`cleanup`方法清理所有Modbus资源后，系统可能需要重新扫描设备并启动服务。

**Section sources**
- [modbus_manager.py](file://src/components/modbus_manager.py#L977-L978)