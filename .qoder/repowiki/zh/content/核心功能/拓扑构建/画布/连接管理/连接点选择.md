# 连接点选择

<cite>
**本文档引用的文件**   
- [canvas.py](file://src/components/canvas.py)
- [network_items.py](file://src/components/network_items.py)
- [network_model.py](file://src/models/network_model.py)
</cite>

## 目录
1. [连接点选择逻辑](#连接点选择逻辑)
2. [属性映射机制](#属性映射机制)
3. [最近距离回退算法](#最近距离回退算法)

## 连接点选择逻辑

`_select_connection_points` 方法实现了针对变压器和线路等多端口组件的智能连接点选择逻辑。该方法根据组件属性（如 `hv_bus`、`lv_bus`、`from_bus`、`to_bus`）与总线ID的匹配关系，自动选择对应的连接点索引。当组件与总线连接时，系统会检查组件的属性配置，如果属性值与目标总线的索引匹配，则优先选择对应的连接点。

该方法主要处理变压器和线路与总线的连接场景，通过 `source_is_first` 参数控制连接点索引的返回顺序，确保连接关系的正确性。对于其他类型的组件连接，则采用最近距离算法选择连接点。

**本节来源**
- [canvas.py](file://src/components/canvas.py#L361-L404)

## 属性映射机制

系统通过预定义的组件类型与属性、连接点索引的映射关系来实现智能连接点选择。对于变压器组件，`hv_bus` 属性映射到连接点索引 0（高压侧），`lv_bus` 属性映射到连接点索引 1（低压侧）。对于线路组件，`from_bus` 属性映射到连接点索引 0（起始侧），`to_bus` 属性映射到连接点索引 1（终止侧）。

当进行连接操作时，系统会检查源组件的类型是否在映射关系中。如果在映射中，则遍历该组件类型的所有可能连接点，比较组件属性值与目标总线的索引是否匹配。一旦找到匹配项，就选择对应的连接点索引；如果连接点不可用，则标记为不可用状态。

这种属性映射机制确保了变压器和线路等多端口组件能够根据其配置属性自动选择正确的连接点，提高了连接操作的准确性和效率。

**本节来源**
- [canvas.py](file://src/components/canvas.py#L378-L381)
- [network_model.py](file://src/models/network_model.py#L507-L524)

## 最近距离回退算法

当无法通过属性匹配确定连接点时，系统会回退到最近距离算法。`find_nearest_connection_point` 方法通过计算场景坐标中的欧几里得距离来确定最优连接点。该方法首先获取目标组件的场景位置，然后遍历源组件的所有可用连接点，计算每个连接点到目标位置的距离。

距离计算采用标准的欧几里得距离公式：`distance = √((x₂-x₁)² + (y₂-y₁)²)`。系统会记录距离最短的连接点及其索引，并返回该最优连接点。对于总线组件，由于其连接点数量不受限制，系统允许所有连接点都参与距离计算。

最近距离算法作为属性匹配机制的补充，确保了在没有明确属性配置的情况下仍能找到最合适的连接点，提高了系统的鲁棒性和用户体验。

**本节来源**
- [canvas.py](file://src/components/canvas.py#L596-L641)
- [network_items.py](file://src/components/network_items.py#L624-L630)